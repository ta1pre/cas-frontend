#!/bin/bash

# å¤ã„ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤
rm -f nextjs.log

echo "ğŸ“ Next.jsã®ãƒ­ã‚°ç›£è¦–ã‚’é–‹å§‹ã—ã¾ã™..."
echo "ğŸ’¡ ãƒ’ãƒ³ãƒˆ: Claude Codeã§ 'claude \"nextjs.logã®ã‚¨ãƒ©ãƒ¼ã‚’ä¿®æ­£ã—ã¦\"' ã¨å…¥åŠ›ã™ã‚‹ã¨è‡ªå‹•ä¿®æ­£ã§ãã¾ã™"
echo "âš ï¸  æ³¨æ„: æ—¢ã«Next.jsãŒèµ·å‹•ã—ã¦ã„ã‚‹å ´åˆã¯ã€ãã®ãƒ—ãƒ­ã‚»ã‚¹ã‚’çµ‚äº†ã—ã¦ã‹ã‚‰å®Ÿè¡Œã—ã¦ãã ã•ã„"
echo ""

# ãƒãƒ¼ãƒˆ3000ã®ä½¿ç”¨çŠ¶æ³ã‚’ç¢ºèª
if lsof -i :3000 >/dev/null 2>&1; then
    echo "âŒ ãƒãƒ¼ãƒˆ3000ã¯æ—¢ã«ä½¿ç”¨ä¸­ã§ã™"
    echo "ğŸ’¡ æ—¢å­˜ã®Next.jsãƒ—ãƒ­ã‚»ã‚¹ã‚’çµ‚äº†ã—ã¦ã‹ã‚‰å†å®Ÿè¡Œã—ã¦ãã ã•ã„"
    echo "   ã¾ãŸã¯ã€æ—¢å­˜ã®ãƒ—ãƒ­ã‚»ã‚¹ã®ãƒ­ã‚°ã‚’ç¢ºèªã—ãŸã„å ´åˆã¯ã€ãã®ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã§Ctrl+Cã§çµ‚äº†å¾Œã«å®Ÿè¡Œã—ã¦ãã ã•ã„"
    exit 1
fi

# npm run dev ã®å‡ºåŠ›ã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜ã—ãªãŒã‚‰è¡¨ç¤º
npm run dev 2>&1 | while IFS= read -r line; do
    # ç”»é¢ã«è¡¨ç¤º
    echo "$line"
    
    # ãƒ•ã‚¡ã‚¤ãƒ«ã«è¿½åŠ 
    echo "$line" >> nextjs.log
    
    # 300è¡Œã‚’è¶…ãˆãŸã‚‰å¤ã„è¡Œã‚’å‰Šé™¤
    if [ $(wc -l < nextjs.log 2>/dev/null || echo 0) -gt 300 ]; then
        tail -n 300 nextjs.log > nextjs.log.tmp
        mv nextjs.log.tmp nextjs.log
    fi
done